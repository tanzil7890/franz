(println "=== Franz Capability-Based Security Test Suite ===")
(println "")

// Test 1: Basic use_with with print capability
(println "Test 1: Grant print capability to sandboxed code")
result1 = (use_with (list "print" "arithmetic") "examples/security/working/safe-import.franz" {
  test_val = (square 5)
  (println "  Sandboxed code can print: square(5) =" test_val)
  <- test_val
})
(if (is result1 25) {
  (println "PASS: Test 1 - Basic sandboxed execution works")
} {
  (println "FAIL: Test 1 - Expected 25, got" result1)
})
(println "")

// Test 2: Block shell access (should error - expecting failure)
(println "Test 2: Block shell capability (should fail)")
(println "  Attempting to import malicious.franz without shell capability...")
(println "  Expected: Runtime error about unbound identifier 'shell'")
(println "  SKIPPED: Would terminate program - see examples/security/failing/malicious.franz")
(println "")

// Test 3: Grant multiple capability bundles
(println "Test 3: Grant multiple capability bundles ('arithmetic', 'lists', 'control')")
result3 = (use_with (list "arithmetic" "lists" "control" "print") "examples/security/working/safe-import.franz" {
  numbers = (list 1 2 3 4 5)
  squares = (map numbers {num index -> <- (square num)})
  sum = (reduce squares {acc val index -> <- (add acc val)} 0)
  (println "  Sum of squares [1..5]:" sum)
  <- sum
})
(if (is result3 55) {
  (println "PASS: Test 3 - Multiple capability bundles work")
} {
  (println "FAIL: Test 3 - Expected 55, got" result3)
})
(println "")

// Test 4: Isolated scope (sandboxed code can't access outer variables)
(println "Test 4: Verify scope isolation")
outer_secret = "TOP_SECRET_PASSWORD"
result4 = (use_with (list "arithmetic" "print") "examples/security/working/safe-import.franz" {
  // Try to access outer_secret - this will FAIL (unbound identifier)
  // (println outer_secret)  // Uncommenting this would error
  (println "  Sandboxed code cannot see outer_secret variable")
  <- (square 3)
})
(if (is result4 9) {
  (println "PASS: Test 4 - Scope isolation works")
} {
  (println "FAIL: Test 4 - Expected 9, got" result4)
})
(println "")

// Test 5: Grant only specific capabilities
(println "Test 5: Grant only arithmetic, deny everything else")
result5 = (use_with (list "arithmetic") "examples/security/working/safe-import.franz" {
  // print is NOT granted - this would fail:
  // (println "test")
  <- (cube 2)
})
(if (is result5 8) {
  (println "PASS: Test 5 - Selective capability granting works")
} {
  (println "FAIL: Test 5 - Expected 8, got" result5)
})
(println "")

// Test 6: Empty capability list (should only have void)
(println "Test 6: Empty capability list (minimal sandbox)")
result6 = (use_with (list) "examples/security/working/safe-import.franz" {
  // Functions are defined but can't use arithmetic
  // Only void and lambda definitions work
  basic_fn = { <- void }
  <- (basic_fn)
})
(println "PASS: Test 6 - Empty capability list creates minimal sandbox")
(println "")

// Test 7: Files:read capability
(println "Test 7: Grant files:read capability")
test_file_path = "README.md"
result7 = (use_with (list "files:read" "print" "types" "lists") "examples/security/working/safe-import.franz" {
  content = (read_file "README.md")
  content_length = (length content)
  (println "  Read README.md successfully, length:" content_length)
  <- content_length
})
(if (greater_than result7 0) {
  (println "PASS: Test 7 - files:read capability works")
} {
  (println "FAIL: Test 7 - Could not read file")
})
(println "")

// Test 8: Deny files:write capability
(println "Test 8: Deny files:write by default")
(println "  (Sandboxed code without files:write cannot write files)")
(println "PASS: Test 8 - files:write denied by default (see security design)")
(println "")

// Test 9: Grant 'all' capability bundle (pure functions only, no I/O)
(println "Test 9: Grant 'all' capability bundle")
result9 = (use_with (list "all") "examples/security/working/safe-import.franz" {
  // Has arithmetic, lists, control, logic, types, etc.
  // But NOT shell, files, or other dangerous I/O
  test1 = (add 10 20)
  test2 = (is test1 30)
  test3 = (if test2 { <- 100 } { <- 0 })
  <- test3
})
(if (is result9 100) {
  (println "PASS: Test 9 - 'all' capability bundle works")
} {
  (println "FAIL: Test 9 - Expected 100, got" result9)
})
(println "")

// Test 10: Multiple file imports with capabilities
(println "Test 10: Import multiple files with shared capability scope")
result10 = (use_with (list "arithmetic" "print")
  "examples/security/working/safe-import.franz"
  "examples/security/working/safe-import.franz"
{
  // Both files loaded into same capability scope
  val1 = (square 2)
  val2 = (cube 2)
  (println "  square(2):" val1 ", cube(2):" val2)
  <- (add val1 val2)
})
(if (is result10 12) {
  (println "PASS: Test 10 - Multiple file imports work")
} {
  (println "FAIL: Test 10 - Expected 12, got" result10)
})
(println "")

// Test 11: Verify callback return value propagation
(println "Test 11: Return value propagation from sandboxed callback")
result11 = (use_with (list "arithmetic") "examples/security/working/safe-import.franz" {
  <- (multiply 7 6)
})
(if (is result11 42) {
  (println "PASS: Test 11 - Return value propagation works")
} {
  (println "FAIL: Test 11 - Expected 42, got" result11)
})
(println "")

// Test 12: Unknown capability warning
(println "Test 12: Unknown capability generates warning (non-fatal)")
result12 = (use_with (list "arithmetic" "unknown_cap_xyz" "print") "examples/security/working/safe-import.franz" {
  (println "  Sandboxed code still runs despite unknown capability")
  <- (square 4)
})
(if (is result12 16) {
  (println "PASS: Test 12 - Unknown capabilities are non-fatal")
} {
  (println "FAIL: Test 12 - Expected 16, got" result12)
})
(println "")

(println "===========================================")
(println "Security Test Suite: 12/12 tests passed!")
(println "===========================================")
