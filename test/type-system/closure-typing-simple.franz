(println "=== Simplified Type System Closure Tests ===")
(println "")

passed = 0
failed = 0

// Test 1: Simple closure with type annotation
(println "Test 1: Simple closure type")
(sig add_one (int -> int))
add_one = {x -> <- (add x 1)}
result1 = (add_one 5)
(if (is result1 6)
  {->
    passed = (add passed 1)
    (println "  ✓ PASS: add_one(5) = " result1)
  }
  {->
    failed = (add failed 1)
    (println "  ✗ FAIL: Expected 6, got " result1)
  }
)

// Test 2: Closure factory (higher-order function)
(println "Test 2: Closure factory")
(sig make_adder (int -> (int -> int)))
make_adder = {n ->
  <- {x -> <- (add x n)}
}
add5 = (make_adder 5)
result2 = (add5 10)
(if (is result2 15)
  {->
    passed = (add passed 1)
    (println "  ✓ PASS: make_adder(5)(10) = " result2)
  }
  {->
    failed = (add failed 1)
    (println "  ✗ FAIL: Expected 15, got " result2)
  }
)

// Test 3: Nested closures (3 levels)
(println "Test 3: Three-level nested closure")
level1 = {->
  a = 1
  level2 = {->
    b = 2
    level3 = {->
      <- (add a b)
    }
    <- level3
  }
  <- level2
}
closure2 = (level1)
closure3 = (closure2)
result3 = (closure3)
(if (is result3 3)
  {->
    passed = (add passed 1)
    (println "  ✓ PASS: Three-level closure = " result3)
  }
  {->
    failed = (add failed 1)
    (println "  ✗ FAIL: Expected 3, got " result3)
  }
)

// Test 4: Polymorphic identity function
(println "Test 4: Polymorphic identity")
(sig identity (a -> a))
identity = {x -> <- x}
result4 = (identity 42)
(if (is result4 42)
  {->
    passed = (add passed 1)
    (println "  ✓ PASS: identity(42) = " result4)
  }
  {->
    failed = (add failed 1)
    (println "  ✗ FAIL: Expected 42, got " result4)
  }
)

// Test 5: Closure captures free variable
(println "Test 5: Free variable capture")
multiplier = 3
times_n = {x -> <- (multiply x multiplier)}
result5 = (times_n 7)
(if (is result5 21)
  {->
    passed = (add passed 1)
    (println "  ✓ PASS: times_n(7) with multiplier=3 = " result5)
  }
  {->
    failed = (add failed 1)
    (println "  ✗ FAIL: Expected 21, got " result5)
  }
)

// Test 6: Multiple independent closures
(println "Test 6: Independent closures")
(sig make_multiplier (int -> (int -> int)))
make_multiplier = {factor ->
  <- {n -> <- (multiply n factor)}
}
times2 = (make_multiplier 2)
times3 = (make_multiplier 3)
result6a = (times2 5)
result6b = (times3 5)
(if (is result6a 10)
  {->
    passed = (add passed 1)
    (println "  ✓ PASS: times2(5) = " result6a)
  }
  {->
    failed = (add failed 1)
    (println "  ✗ FAIL: times2 expected 10, got " result6a)
  }
)
(if (is result6b 15)
  {->
    passed = (add passed 1)
    (println "  ✓ PASS: times3(5) = " result6b)
  }
  {->
    failed = (add failed 1)
    (println "  ✗ FAIL: times3 expected 15, got " result6b)
  }
)

// Test 7: Closure with map
(println "Test 7: Higher-order function (map)")
double_fn = {x i -> <- (multiply x 2)}
nums7 = (list 1 2 3 4 5)
result7 = (map nums7 double_fn)
first_elem = (head result7)
(if (is first_elem 2)
  {->
    passed = (add passed 1)
    (println "  ✓ PASS: map with closure works")
  }
  {->
    failed = (add failed 1)
    (println "  ✗ FAIL: map with closure")
  }
)

// Test 8: Function composition
(println "Test 8: Function composition")
add10 = {x -> <- (add x 10)}
multiply2 = {x -> <- (multiply x 2)}
compose = {f g x -> <- (f (g x))}
result8 = (compose multiply2 add10 5)
(if (is result8 30)
  {->
    passed = (add passed 1)
    (println "  ✓ PASS: compose(multiply2, add10)(5) = " result8)
  }
  {->
    failed = (add failed 1)
    (println "  ✗ FAIL: Expected 30, got " result8)
  }
)

// Test 9: Closure with reduce
(println "Test 9: Closure with reduce")
sum_fn = {acc item i -> <- (add acc item)}
nums9 = (list 1 2 3 4 5)
result9 = (reduce nums9 sum_fn 0)
(if (is result9 15)
  {->
    passed = (add passed 1)
    (println "  ✓ PASS: reduce sum = " result9)
  }
  {->
    failed = (add failed 1)
    (println "  ✗ FAIL: Expected 15, got " result9)
  }
)

// Test 10: Closure with filter
(println "Test 10: Closure with filter")
threshold = 3
greater_fn = {x i -> <- (greater_than x threshold)}
nums10 = (list 1 2 3 4 5)
result10 = (filter nums10 greater_fn)
filtered_len = (length result10)
(if (is filtered_len 2)
  {->
    passed = (add passed 1)
    (println "  ✓ PASS: filter with closure works (filtered " filtered_len " items)")
  }
  {->
    failed = (add failed 1)
    (println "  ✗ FAIL: Expected 2 filtered items, got " filtered_len)
  }
)

(println "")
(println "=== Test Results ===")
(println "Passed: " passed "/10")
(println "Failed: " failed "/10")
(if (is failed 0)
  {-> (println "✓ ALL TESTS PASSED!")}
  {-> (println "✗ Some tests failed")}
)
