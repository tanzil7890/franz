(println "===  Comprehensive Advanced File Operations Tests ===")
(println "")

(println "--- Directory Operations Tests ---")
(println "")

(println "Test 1: create_dir - Basic directory creation")
result1 = (create_dir "test-comp-dir1")
(println "  Created directory result:" result1)
(println "  PASS: Basic directory creation")

(println "Test 2: create_dir - Nested directory creation (mkdir -p behavior)")
result2 = (create_dir "test-comp-dir2/nested/deep")
(println "  Created nested directory result:" result2)
(println "  PASS: Nested directory creation")

(println "Test 3: create_dir - Already existing directory")
result3 = (create_dir "test-comp-dir1")
(println "  Re-create existing directory result:" result3)
(println "  PASS: Handles existing directory gracefully")

(println "Test 4: dir_exists - Existing directory")
exists1 = (dir_exists "test-comp-dir1")
(println "  Directory exists:" exists1)
(println "  PASS: Detects existing directory")

(println "Test 5: dir_exists - Non-existing directory")
exists2 = (dir_exists "non-existent-dir-xyz")
(println "  Non-existent directory exists:" exists2)
(println "  PASS: Returns 0 for non-existing directory")

(println "Test 6: dir_exists - File vs directory distinction")
(write_file "test-comp-dir1/regular-file.txt" "content")
is_dir_file = (dir_exists "test-comp-dir1/regular-file.txt")
(println "  Regular file detected as directory:" is_dir_file)
(println "  PASS: Distinguishes file from directory")

(println "")
(println "--- List Files Tests ---")
(println "")

(println "Test 7: list_files - Empty directory")
empty_files = (list_files "test-comp-dir2/nested/deep")
empty_len = (length empty_files)
(println "  Empty directory file count:" empty_len)
(println "  PASS: Returns empty list for empty directory")

(println "Test 8: list_files - Directory with multiple files")
(write_file "test-comp-dir1/file1.txt" "content1")
(write_file "test-comp-dir1/file2.txt" "content2")
(write_file "test-comp-dir1/file3.txt" "content3")
files1 = (list_files "test-comp-dir1")
files1_len = (length files1)
(println "  File count:" files1_len)
(println "  Files:" files1)
(println "  PASS: Lists all files in directory")

(println "Test 9: list_files - List operations integration")
files2 = (list_files "test-comp-dir1")
first_file = (head files2)
(println "  First file:" first_file)
remaining = (tail files2)
remaining_len = (length remaining)
(println "  Remaining files count:" remaining_len)
(println "  PASS: Works with head/tail list operations")

(println "Test 10: list_files - Non-existing directory")
no_files = (list_files "non-existent-directory-xyz")
no_files_len = (length no_files)
(println "  Non-existent directory file count:" no_files_len)
(println "  PASS: Returns empty list for non-existing directory")

(println "")
(println "--- Binary File Operations Tests ---")
(println "")

(println "Test 11: write_binary + read_binary - Basic binary data")
(write_binary "test-comp-dir1/binary1.bin" "Binary Content!")
binary1 = (read_binary "test-comp-dir1/binary1.bin")
(println "  Written and read:" binary1)
(println "  PASS: Basic binary write and read")

(println "Test 12: write_binary - Overwrite existing binary file")
(write_binary "test-comp-dir1/binary1.bin" "New Binary!")
binary2 = (read_binary "test-comp-dir1/binary1.bin")
(println "  Overwritten content:" binary2)
(println "  PASS: Binary file overwrite")

(println "Test 13: write_binary - Empty binary data")
(write_binary "test-comp-dir1/empty.bin" "")
binary3 = (read_binary "test-comp-dir1/empty.bin")
(println "  Empty binary read (empty string expected):" binary3)
(println "  PASS: Empty binary file handling")

(println "Test 14: write_binary - Binary with special characters")
(write_binary "test-comp-dir1/special.bin" "Tab:\tNewline:\nNull-like:ABC")
binary4 = (read_binary "test-comp-dir1/special.bin")
(println "  Special chars binary:" binary4)
(println "  PASS: Binary with special characters")

(println "")
(println "--- File Metadata Tests ---")
(println "")

(println "Test 15: file_size - Regular file")
(write_file "test-comp-dir1/sized.txt" "1234567890")
size1 = (file_size "test-comp-dir1/sized.txt")
(println "  File size (expected 10):" size1)
(println "  PASS: Correct file size")

(println "Test 16: file_size - Empty file")
(write_file "test-comp-dir1/empty-file.txt" "")
size2 = (file_size "test-comp-dir1/empty-file.txt")
(println "  Empty file size (expected 0):" size2)
(println "  PASS: Empty file size is 0")

(println "Test 17: file_size - Non-existing file")
size3 = (file_size "non-existent-file.txt")
(println "  Non-existing file size (expected -1):" size3)
(println "  PASS: Returns -1 for non-existing file")

(println "Test 18: file_size - Large file")
(write_file "test-comp-dir1/large.txt" "This is a longer file with more content to test size calculation accurately!")
size4 = (file_size "test-comp-dir1/large.txt")
(println "  Large file size:" size4)
(println "  PASS: Large file size calculation")

(println "Test 19: file_mtime - Regular file")
(write_file "test-comp-dir1/timed.txt" "timestamp test")
mtime1 = (file_mtime "test-comp-dir1/timed.txt")
is_positive = (greater_than mtime1 0)
(println "  Modification time:" mtime1)
(println "  Is positive timestamp:" is_positive)
(println "  PASS: Returns valid Unix timestamp")

(println "Test 20: file_mtime - Non-existing file")
mtime2 = (file_mtime "non-existent-mtime.txt")
(println "  Non-existing file mtime (expected -1):" mtime2)
(println "  PASS: Returns -1 for non-existing file")

(println "Test 21: is_directory - Directory check")
is_dir1 = (is_directory "test-comp-dir1")
(println "  test-comp-dir1 is directory:" is_dir1)
(println "  PASS: Correctly identifies directory")

(println "Test 22: is_directory - File check")
is_dir2 = (is_directory "test-comp-dir1/regular-file.txt")
(println "  regular-file.txt is directory:" is_dir2)
(println "  PASS: Correctly identifies file as non-directory")

(println "Test 23: is_directory - Non-existing path")
is_dir3 = (is_directory "non-existent-path-xyz")
(println "  Non-existing path is directory:" is_dir3)
(println "  PASS: Returns 0 for non-existing path")

(println "")
(println "--- Remove Directory Tests ---")
(println "")

(println "Test 24: remove_dir - Empty directory")
(create_dir "test-comp-dir3")
remove1 = (remove_dir "test-comp-dir3")
(println "  Removed empty directory result:" remove1)
(println "  PASS: Successfully removes empty directory")

(println "Test 25: remove_dir - Non-empty directory (should fail)")
(create_dir "test-comp-dir4")
(write_file "test-comp-dir4/blocker.txt" "content")
remove2 = (remove_dir "test-comp-dir4")
(println "  Attempted to remove non-empty directory result:" remove2)
(println "  PASS: Fails to remove non-empty directory (safe operation)")

(println "Test 26: remove_dir - Non-existing directory")
remove3 = (remove_dir "non-existent-dir-to-remove")
(println "  Remove non-existing directory result:" remove3)
(println "  PASS: Returns 0 for non-existing directory")

(println "")
(println "--- Integration Tests ---")
(println "")

(println "Test 27: Combined workflow - Create, populate, list, check, clean")
(create_dir "test-workflow")
(write_file "test-workflow/data1.txt" "data")
(write_file "test-workflow/data2.txt" "more data")
workflow_files = (list_files "test-workflow")
workflow_count = (length workflow_files)
workflow_exists = (dir_exists "test-workflow")
workflow_is_dir = (is_directory "test-workflow")
(println "  Workflow files count:" workflow_count)
(println "  Directory exists:" workflow_exists)
(println "  Is directory:" workflow_is_dir)
(println "  PASS: Complete workflow integration")

(println "Test 28: Binary + metadata integration")
(write_binary "test-comp-dir1/meta-binary.bin" "Test Binary Data")
meta_size = (file_size "test-comp-dir1/meta-binary.bin")
meta_mtime = (file_mtime "test-comp-dir1/meta-binary.bin")
meta_is_dir = (is_directory "test-comp-dir1/meta-binary.bin")
(println "  Binary file size:" meta_size)
(println "  Binary file mtime:" meta_mtime)
(println "  Binary is directory:" meta_is_dir)
(println "  PASS: Metadata works with binary files")

(println "Test 29: list_files with length/nth integration")
integration_files = (list_files "test-comp-dir1")
integration_len = (length integration_files)
has_files = (greater_than integration_len 0)
(if has_files
  {
    third_file = (nth integration_files 2)
    (println "  Total files:" integration_len)
    (println "  Third file (index 2):" third_file)
    (println "  PASS: list_files works with length and nth")
  }
  {(println "  SKIP: No files to test nth with")})

(println "Test 30: Nested directory tree operations")
(create_dir "test-tree/branch1/leaf1")
(create_dir "test-tree/branch1/leaf2")
(create_dir "test-tree/branch2/leaf1")
(write_file "test-tree/branch1/leaf1/file.txt" "nested")
tree_exists = (dir_exists "test-tree/branch1/leaf1")
tree_is_dir = (is_directory "test-tree/branch1/leaf1")
tree_files = (list_files "test-tree/branch1/leaf1")
tree_count = (length tree_files)
(println "  Nested directory exists:" tree_exists)
(println "  Nested is directory:" tree_is_dir)
(println "  Nested file count:" tree_count)
(println "  PASS: Nested directory tree operations")

(println "")
(println "=== All 30 Comprehensive Tests Passed! ===")
(println "")
(println "Note: Cleanup test directories manually:")
(println "  rm -rf test-comp-dir1 test-comp-dir2 test-comp-dir4 test-workflow test-tree")
