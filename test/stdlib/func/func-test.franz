(use "stdlib/func.franz" {
  (println "=== Higher-Order Function Utilities Test Suite ===")
  (println "")

  // ========================================================================
  // COMPOSE2 TESTS
  // ========================================================================

  (println "Test 1: compose2 - Basic composition")
  double = {x -> <- (multiply x 2)}
  increment = {x -> <- (add x 1)}
  test1_result = (compose2 5 double increment)
  (if (is test1_result 12) {
    (println "PASS: compose2 works ((5 + 1) * 2 = 12)")
  } {
    (println "FAIL: Expected 12, got" test1_result)
  })

  (println "Test 2: compose2 - With subtract")
  add_ten = {x -> <- (add x 10)}
  square = {x -> <- (multiply x x)}
  test2_result = (compose2 5 square add_ten)
  expected2 = (multiply (add 5 10) (add 5 10))
  (if (is test2_result expected2) {
    (println "PASS: compose2 with subtract ((5 + 10)^2 = 225)")
  } {
    (println "FAIL: Expected" expected2 "got" test2_result)
  })

  (println "Test 3: compose2 - With identity")
  test3_result = (compose2 42 identity identity)
  (if (is test3_result 42) {
    (println "PASS: compose2 with identity preserves value")
  } {
    (println "FAIL: Expected 42, got" test3_result)
  })

  // ========================================================================
  // IDENTITY TESTS
  // ========================================================================

  (println "")
  (println "Test 4: identity - Returns integer unchanged")
  test4_result = (identity 42)
  (if (is test4_result 42) {
    (println "PASS: identity returns integer unchanged")
  } {
    (println "FAIL: Expected 42, got" test4_result)
  })

  (println "Test 5: identity - Returns string unchanged")
  test5_result = (identity "hello")
  (if (is test5_result "hello") {
    (println "PASS: identity returns string unchanged")
  } {
    (println "FAIL: Expected 'hello', got" test5_result)
  })

  (println "Test 6: identity - Returns list unchanged")
  test6_list = (list 1 2 3)
  test6_result = (identity test6_list)
  test6_first = (get test6_result 0)
  (if (is test6_first 1) {
    (println "PASS: identity returns list unchanged")
  } {
    (println "FAIL: List not preserved correctly")
  })

  // ========================================================================
  // CONSTANT TESTS
  // ========================================================================

  (println "")
  (println "Test 7: constant - Returns first argument")
  test7_result = (constant 42 999)
  (if (is test7_result 42) {
    (println "PASS: constant returns first argument, ignores second")
  } {
    (println "FAIL: Expected 42, got" test7_result)
  })

  (println "Test 8: constant - Works with strings")
  test8_result = (constant "hello" "world")
  (if (is test8_result "hello") {
    (println "PASS: constant works with strings")
  } {
    (println "FAIL: Expected 'hello', got" test8_result)
  })

  (println "Test 9: constant - Can ignore any second argument")
  test9_result = (constant 100 (list 1 2 3))
  (if (is test9_result 100) {
    (println "PASS: constant ignores complex second argument")
  } {
    (println "FAIL: Expected 100, got" test9_result)
  })

  // ========================================================================
  // FLIP TESTS
  // ========================================================================

  (println "")
  (println "Test 10: flip - Flips subtract arguments")
  test10_result = (flip subtract 5 10)
  (if (is test10_result 5) {
    (println "PASS: flip reverses arguments (10 - 5 = 5)")
  } {
    (println "FAIL: Expected 5, got" test10_result)
  })

  (println "Test 11: flip - Flips divide arguments")
  test11_result = (flip divide 2 10)
  (if (is test11_result 5) {
    (println "PASS: flip works with divide (10 / 2 = 5)")
  } {
    (println "FAIL: Expected 5, got" test11_result)
  })

  (println "Test 12: flip - With custom function")
  custom_fn = {a b -> <- (subtract (multiply a 2) b)}
  test12_result = (flip custom_fn 3 10)
  expected12 = (subtract (multiply 10 2) 3)
  (if (is test12_result expected12) {
    (println "PASS: flip works with custom function (10*2 - 3 = 17)")
  } {
    (println "FAIL: Expected" expected12 "got" test12_result)
  })

  // ========================================================================
  // APPLY TESTS
  // ========================================================================

  (println "")
  (println "Test 13: apply - Apply function to list of arguments")
  test13_args = (list 1 2 3 4)
  test13_result = (apply add test13_args)
  (if (is test13_result 10) {
    (println "PASS: apply works with multiple arguments (1+2+3+4 = 10)")
  } {
    (println "FAIL: Expected 10, got" test13_result)
  })

  (println "Test 14: apply - With two arguments")
  test14_args = (list 10 5)
  test14_result = (apply multiply test14_args)
  (if (is test14_result 50) {
    (println "PASS: apply works with two arguments (10 * 5 = 50)")
  } {
    (println "FAIL: Expected 50, got" test14_result)
  })

  (println "Test 15: apply - With single argument")
  test15_args = (list 42)
  test15_result = (apply identity test15_args)
  (if (is test15_result 42) {
    (println "PASS: apply works with single argument")
  } {
    (println "FAIL: Expected 42, got" test15_result)
  })

  (println "Test 16: apply - With custom function")
  max_fn = {a b -> <- (if (greater_than a b) { <- a } { <- b })}
  test16_args = (list 10 20)
  test16_result = (apply max_fn test16_args)
  (if (is test16_result 20) {
    (println "PASS: apply works with custom function (max(10, 20) = 20)")
  } {
    (println "FAIL: Expected 20, got" test16_result)
  })

  // ========================================================================
  // APPLY_TWICE TESTS
  // ========================================================================

  (println "")
  (println "Test 17: apply_twice - Apply function twice")
  test17_result = (apply_twice increment 5)
  (if (is test17_result 7) {
    (println "PASS: apply_twice works (5 + 1 + 1 = 7)")
  } {
    (println "FAIL: Expected 7, got" test17_result)
  })

  (println "Test 18: apply_twice - With double")
  test18_result = (apply_twice double 3)
  (if (is test18_result 12) {
    (println "PASS: apply_twice with double (3 * 2 * 2 = 12)")
  } {
    (println "FAIL: Expected 12, got" test18_result)
  })

  (println "Test 19: apply_twice - With square")
  test19_result = (apply_twice square 2)
  (if (is test19_result 16) {
    (println "PASS: apply_twice with square (2^2^2 = 16)")
  } {
    (println "FAIL: Expected 16, got" test19_result)
  })

  // ========================================================================
  // APPLY_N TESTS
  // ========================================================================

  (println "")
  (println "Test 20: apply_n - Apply 0 times")
  test20_result = (apply_n increment 10 0)
  (if (is test20_result 10) {
    (println "PASS: apply_n with n=0 returns original value")
  } {
    (println "FAIL: Expected 10, got" test20_result)
  })

  (println "Test 21: apply_n - Apply 1 time")
  test21_result = (apply_n increment 10 1)
  (if (is test21_result 11) {
    (println "PASS: apply_n with n=1 applies once")
  } {
    (println "FAIL: Expected 11, got" test21_result)
  })

  (println "Test 22: apply_n - Apply 3 times")
  test22_result = (apply_n increment 5 3)
  (if (is test22_result 8) {
    (println "PASS: apply_n applies function 3 times (5+1+1+1 = 8)")
  } {
    (println "FAIL: Expected 8, got" test22_result)
  })

  (println "Test 23: apply_n - Apply 5 times with double")
  test23_result = (apply_n double 1 5)
  expected23 = (multiply 1 (multiply 2 (multiply 2 (multiply 2 (multiply 2 2)))))
  (if (is test23_result expected23) {
    (println "PASS: apply_n applies double 5 times (1*2^5 = 32)")
  } {
    (println "FAIL: Expected" expected23 "got" test23_result)
  })

  // ========================================================================
  // INTEGRATION TESTS
  // ========================================================================

  (println "")
  (println "Test 24: Integration - compose2 + flip")
  flip_sub = {x -> <- (flip subtract 100 x)}
  test24_result = (compose2 30 flip_sub increment)
  expected24 = (subtract (add 30 1) 100)
  (if (is test24_result expected24) {
    (println "PASS: compose2 + flip integration ((30+1) - 100 = -69)")
  } {
    (println "FAIL: Expected" expected24 "got" test24_result)
  })

  (println "Test 25: Integration - apply_n + compose2")
  triple = {x -> <- (multiply x 3)}
  test25_result = (apply_n {x -> <- (compose2 x triple increment)} 2 2)
  expected25 = (multiply (add (multiply (add 2 1) 3) 1) 3)
  (if (is test25_result expected25) {
    (println "PASS: apply_n + compose2 works")
  } {
    (println "FAIL: Expected" expected25 "got" test25_result)
  })

  (println "Test 26: Integration - apply + flip")
  flipped_subtract = {a b -> <- (flip subtract a b)}
  test26_args = (list 5 20)
  test26_result = (apply flipped_subtract test26_args)
  (if (is test26_result 15) {
    (println "PASS: apply + flip works (20 - 5 = 15)")
  } {
    (println "FAIL: Expected 15, got" test26_result)
  })

  (println "Test 27: Integration - apply_twice + identity")
  test27_result = (apply_twice identity 42)
  (if (is test27_result 42) {
    (println "PASS: apply_twice identity is identity")
  } {
    (println "FAIL: Expected 42, got" test27_result)
  })

  (println "Test 28: Integration - constant + apply_n")
  always_5 = {x -> <- (constant 5 x)}
  test28_result = (apply_n always_5 100 3)
  (if (is test28_result 5) {
    (println "PASS: constant converges to fixed value")
  } {
    (println "FAIL: Expected 5, got" test28_result)
  })

  (println "")
  (println "âœ“ All 28 function utility tests completed!")
})
